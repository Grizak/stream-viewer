<!doctype html>
<html lang="en">
  <head>
    <title>Stream Viewer</title>
    <meta charset="UTF-8" />

    <!-- xterm -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css"
    />

    <style>
      :root {
        --bg: #1e1e1e;
        --panel: #252526;
        --border: #3e3e42;
        --text: #d4d4d4;
        --muted: #9da0a2;
        --green: #4ec9b0;
        --yellow: #dcdcaa;
        --red: #f48771;
        --blue: #0e639c;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Menlo", "Monaco", "Ubuntu Mono", monospace;
        background: var(--bg);
        color: var(--text);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ---------------- Header ---------------- */

      header {
        height: 44px;
        background: var(--panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 14px;
        gap: 16px;
        flex-shrink: 0;
      }

      .title {
        font-weight: 600;
        font-size: 13px;
      }

      .status {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #333;
      }

      .status.running {
        color: var(--green);
      }

      .status.exited {
        color: var(--yellow);
      }

      .status.viewer {
        color: var(--muted);
      }

      .spacer {
        flex: 1;
      }

      button {
        background: var(--blue);
        border: none;
        color: white;
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background: #1177bb;
      }

      button.secondary {
        background: #3a3d41;
      }

      button.secondary:hover {
        background: #45484d;
      }

      button.danger {
        background: #c74e39;
      }

      button.danger:hover {
        background: #d16969;
      }

      /* ---------------- Terminal ---------------- */

      main {
        flex: 1;
        overflow: hidden;
      }

      #terminal {
        height: 100%;
        padding: 10px;
      }

      .xterm {
        height: 100%;
      }

      /* ---------------- Footer ---------------- */

      footer {
        height: 28px;
        background: var(--panel);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 12px;
        font-size: 11px;
        color: var(--muted);
        gap: 16px;
      }

      footer label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header>
      <div class="title">Stream Viewer</div>
      <div id="status" class="status viewer">Connecting…</div>

      <div class="spacer"></div>

      <button class="secondary" onclick="clearTerminal()">Clear</button>
      <button class="secondary" onclick="downloadLog()">Download</button>
      <button class="danger" onclick="shutdown()">Shutdown</button>
    </header>

    <!-- Terminal -->
    <main>
      <div id="terminal"></div>
    </main>

    <!-- Footer -->
    <footer>
      <label>
        <input
          type="checkbox"
          id="autoscroll"
          checked
          onchange="autoScroll = this.checked"
        />
        Autoscroll
      </label>
      <div id="footer-info">—</div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
      /* ---------------- Terminal ---------------- */

      const term = new Terminal({
        cursorBlink: true,
        fontSize: 13,
        lineHeight: 1.4,
        theme: {
          background: "#1e1e1e",
          foreground: "#d4d4d4",
          cursor: "#d4d4d4",
        },
      });

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);

      const terminalEl = document.getElementById("terminal");
      term.open(terminalEl);
      fitAddon.fit();

      window.addEventListener("resize", () => fitAddon.fit());

      /* ---------------- State ---------------- */

      const statusEl = document.getElementById("status");
      const footerInfo = document.getElementById("footer-info");

      let autoScroll = true;
      let fullLog = "";

      /* ---------------- Socket ---------------- */

      const socket = io();

      socket.on("connect", () => {
        statusEl.textContent = "Connected";
        statusEl.className = "status viewer";
      });

      socket.on("disconnect", () => {
        statusEl.textContent = "Disconnected";
        statusEl.className = "status viewer";
      });

      socket.on("state", (state) => {
        if (state.running) {
          statusEl.textContent = "Process running";
          statusEl.className = "status running";
        } else if (state.exited) {
          statusEl.textContent = "Process exited";
          statusEl.className = "status exited";
        } else {
          statusEl.textContent = "Viewer only";
          statusEl.className = "status viewer";
        }
      });

      socket.on("data", (chunk) => {
        term.write(chunk);
        fullLog += chunk;
        footerInfo.textContent = `${fullLog.length.toLocaleString()} bytes`;
        if (autoScroll) term.scrollToBottom();
      });

      socket.on("history", (history) => {
        term.reset();
        for (const chunk of history) {
          term.write(chunk);
          fullLog += chunk;
        }
        term.scrollToBottom();
      });

      /* ---------------- Actions ---------------- */

      function clearTerminal() {
        term.clear();
        fullLog = "";
        footerInfo.textContent = "Cleared";
      }

      function downloadLog() {
        const blob = new Blob([fullLog], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `stream-log-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function shutdown() {
        if (confirm("Shut down Stream Viewer?")) {
          socket.emit("shutdown");
        }
      }
    </script>
  </body>
</html>
